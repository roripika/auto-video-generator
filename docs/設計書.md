# Auto Video Generator 現状仕様ドキュメント（ドラフト）

## 1. 目的
- テキストブリーフから自動で台本生成・音声合成・映像合成を行い、YouTubeアップロードまで自動化する。
- トレンドネタ（LLM/YouTubeランキング）から台本を自動生成し、定期的に動画を量産する。
- ショート/通常を自動切替し、縦横テロップやBGMバランスを調整する。

## 2. 想定ユーザ
- ノンコーディングの動画制作者（初心者でもワンクリック生成したい）。
- コンテンツ量産をしたい運用担当（定期実行タスクで放置運用したい）。
- 開発者/運用者（トラブル時にログを見て原因を特定したい）。

## 3. 主なユースケース
- GUIで「AI台本生成」→「動画生成」→「YouTubeアップロード」を実行。
- 定期実行タスクでトレンドネタから動画を自動生成し、必要に応じてアップロード。
- ショート動画を自動判定（60秒以下）または手動指定し、縦長レイアウトでテロップを自動調整。
- 生成済み動画（outputs/rendered/*.mp4）を後からGUIで再アップロード。

## 4. 機能一覧（現状）
- **台本生成**
  - `scripts/generate_script_from_brief.py`: ブリーフ→YAML台本生成。テーマ切替あり。
  - LLMプロバイダ: OpenAI / Gemini（優先順位は設定ファイル）。
  - ショート推定: 生成文字量から推定し short_mode を auto/off/short で制御。
- **トレンド取得/定期実行**
  - `scripts/auto_trend_pipeline.py`: `--source llm` でトレンド案をLLM生成し、重複除外→1件採用→台本生成→動画生成→（任意）YouTubeアップ。
  - 履歴管理: `work/topic_history.json`、window_daysで重複除外。
  - `--adjust-tickers` デフォルトON（自動実行では強制ON）でテロップ幅を事前調整。
  - ショートモード: auto（60秒以下で縦 1080x1920）。
- **動画生成**
  - `scripts/generate_video.py`: 音声合成→映像合成→ffmpeg実行。`--adjust-tickers` で `scripts/adjust_tickers.py` を介しテロップ幅・改行を調整。
  - `src/render/ffmpeg_runner.py`: 縦横切替、テロップ描画（Noto Sans JP等）、ショート時は座標/フォントスケールを縮小。
  - `scripts/render_snapshot.py`: 1フレームPNGでレイアウト確認（プレビュー用）。
- **素材取得**
  - 背景: Pexels/Pixabay（優先順位設定）。キーワードは台本YAMLの `bg_keyword`。取得失敗時はローカルデフォルト。
  - BGM: YouTube指定URL or YouTube Audio Library 自動取得。
  - 音声: VOICEVOXエンジン（tools/voicevox_engine）。
- **YouTubeアップロード**
  - `scripts/youtube_upload.py`: OAuthクレデンシャル（pickle）を使ってアップロード。サムネ自動生成（タイトル入りPNG）。
  - GUI: 認証テスト、トークン削除ボタン（現在修正中）。
- **GUI（Electron）**
  - タブ構成: メイン画面（台本生成/動画生成/アップロード）、設定画面。
  - 状態表示: AI問い合わせ中のステータスを長めに保持。
  - 定期実行タスクUI: タスク一覧、タスク追加、次回実行予定リスト（スクロール）、同時実行数、ショート指定、カテゴリ指定、追加キーワード、YouTube自動アップロードなど。
  - 生成動画一覧表示（計画中）と削除機能（要確認）。

## 5. アーキテクチャ
- フロント: Electron + Renderer(JS) + IPC(Main) で Pythonスクリプトを子プロセス実行。
- バック: Python 3.11 想定（pyenv or Homebrew python）。主要依存: pydantic v2, Pillow, requests, pytest, ffmpeg, yt-dlp, google-api-python-client, google-auth。
- キャッシュ/生成物:
  - 台本: `scripts/generated/auto_trend/*.yaml`
  - 動画/メタ: `outputs/rendered/*.mp4|.json|.srt`
  - 素材: `assets/cache/**`, BGM: `assets/bgm/**`
  - 履歴: `work/topic_history.json`
- テスト: Node版（YouTube auth helperなど）と Python版（近日拡充中）。

## 6. データフロー（定期実行/LLMソース）
1. `auto_trend_pipeline.py --source llm --adjust-tickers`
2. LLMでトピック候補生成 → 履歴で重複除外 → 1件採用
3. ブリーフ生成（キーワード+seedフレーズ）→ `generate_script_from_brief.py`
4. short_mode 上書き（auto/off/short/inherit）
5. `generate_video.py --adjust-tickers` → ffmpeg合成 → outputs/rendered
6. upload_prep からタイトル/説明/タグ抽出 → `youtube_upload.py`（任意）

## 7. 設定/入力
- GUI設定ファイル: `settings/ai_settings.json`（LLMキー、優先順位、素材APIキー、YouTubeクレデンシャルパスなど）
- テーマ: `configs/themes/*.yaml`
- コマンドライン主要引数: `auto_trend_pipeline.py` の `--short-mode/--max-keywords/--llm-category/--extra-keyword/--adjust-tickers/--youtube-*` など。
- YouTubeクレデンシャル: `~/.config/auto-video-generator/youtube_credentials.pickle`（デフォルト）。

## 8. 既知の課題・リスク（抜粋）
- YouTubeトークン期限切れで再認証が必要（GUIボタン周りのdeleteCredentials IPC要確認）。
- ショート時のテロップは縮小＋改行調整を導入済みだが、背景が極端な構図だとまだはみ出すケースあり（要さらなるレイアウト補正）。
- Pixabay 400エラー頻発（lang/クエリ長/レート制限）。Pexels優先や fallbackロジック改善が必要。
- `adjust_tickers` に未対応の特殊スキーマが来ると落ちる可能性（段階的に防御追加中）。
- VOICEVOX未起動時の失敗がUIでわかりにくい。
- Pythonインストール周り: pyenvビルド失敗事例あり（Homebrew python@3.11を推奨）。

## 9. 今後の改善案
- テロップ幅の事前プレビューをGUIに統合（`render_snapshot.py` 利用）。
- Pixabayエラー時の再試行とクエリ短縮、自動代替キーワード。
- ショート時のテロップ自動改行・スケールをさらに安全側へ（閾値調整、行数上限）。
- YouTube認証UI: 失敗時の自動トークン削除と再認証促し。
- 定期実行タスク: 同時実行キュー制御とアップロードレート制限ハンドリング。
- インストーラ/セットアップ: Homebrew python3.11固定、`npx playwright install` などをワンステップ化。
- ドキュメント自動生成（stepdocs）: シナリオID埋め込みと確実なセレクタ安定化。
