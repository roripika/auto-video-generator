# â±ï¸ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (Lv3 è©³ç´°ä»•æ§˜)

## âœ¨ TL;DR
- å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆsectionï¼‰ã®é–‹å§‹æ™‚åˆ»ãƒ»ç¶™ç¶šæ™‚é–“ãƒ»éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’è¨ˆç®—ã€‚
- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã° `ffprobe` ã§å®Ÿéš›ã®ç§’æ•°å–å¾—ã€‚ãªã‘ã‚Œã°ãƒ†ã‚­ã‚¹ãƒˆé•·ã‹ã‚‰æ¨å®šï¼ˆç›®å®‰ï¼š10 æ–‡å­— = 3 ç§’ï¼‰ã€‚
- `src/timeline.py` ã® `build_timeline()` é–¢æ•°ã§å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç”Ÿæˆã€‚
- çµæœã¯ `SectionTimeline` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® listã€‚FFmpeg filter chain ã§ä½¿ç”¨ã€‚
- å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ï¼š[src/timeline.py](../../../src/timeline.py) å…¨ä½“ã€‚

## ğŸ“š ç”¨èªãƒ»å‰æ
- **SectionTimeline**: id, index, start_sec, duration_sec, audio_path, on_screen_text ã‚’æŒã¤æ§‹é€ ä½“ã€‚
- **ffprobe**: FFmpeg ãƒ„ãƒ¼ãƒ«ã®1ã¤ã€‚ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆç§’æ•°ç­‰ï¼‰ã‚’ JSON ã§å‡ºåŠ›ã€‚
- **duration_hint_sec**: YAML ã§æ˜ç¤ºã•ã‚ŒãŸç¶™ç¶šæ™‚é–“ã€‚æŒ‡å®šãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã€‚
- **text_length_estimate**: ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ¨å®šã•ã‚ŒãŸç§’æ•°ã€‚"â—‹â—‹â—‹" 30æ–‡å­— â‰ˆ 9ç§’ã€‚

## ğŸ§­ èƒŒæ™¯
- ã‚»ã‚¯ã‚·ãƒ§ãƒ³å˜ä½ã«ç•°ãªã‚‹éŸ³å£°ãƒ»ãƒ†ãƒ­ãƒƒãƒ—ãŒå¿…è¦ã€‚å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚åˆ»ã‚’æ­£ç¢ºã«è¨ˆç®—ãŒå¿…é ˆã€‚
- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã‚‚ã€ãƒ†ã‚­ã‚¹ãƒˆé‡ã‹ã‚‰é©åˆ‡ãªç¶™ç¶šæ™‚é–“ã‚’æ¨å®šã—ãªã„ã¨ FFmpeg ãƒ•ã‚£ãƒ«ã‚¿ã®æ™‚é–“æŒ‡å®šãŒç‹‚ã†ã€‚
- ffprobe ã§ç§’æ•°å–å¾—ã™ã‚‹ã“ã¨ã§ã€ç·¨é›†å¾Œã®éŸ³å£°ã§ã‚‚è‡ªå‹•çš„ã«ç§’æ•°ã‚’æ›´æ–°ã€‚

## ğŸ—ï¸ å®Ÿè£…è©³ç´°

### ã‚¯ãƒ©ã‚¹å®šç¾©ï¼ˆsrc/timeline.py è¡Œ 1-30ï¼‰
```python
@dataclass
class SectionTimeline:
    id: str                              # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ID
    index: int                           # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ï¼ˆ0ã‹ã‚‰ï¼‰
    start_sec: float                     # é–‹å§‹æ™‚åˆ»ï¼ˆç§’ï¼‰
    duration_sec: float                  # ç¶™ç¶šæ™‚é–“ï¼ˆç§’ï¼‰
    on_screen_text: str                  # ãƒ†ãƒ­ãƒƒãƒ—ãƒ†ã‚­ã‚¹ãƒˆ
    narration: str                       # ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆYAML ã‹ã‚‰ï¼‰
    audio_path: Optional[Path]           # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    has_audio: bool = False              # éŸ³å£°ãŒã‚ã‚‹ã‹
```

### ãƒ¡ã‚¤ãƒ³é–¢æ•°ï¼šbuild_timeline()ï¼ˆè¡Œ 40-100ï¼‰

#### å…¥åŠ›
```python
def build_timeline(
    script: ScriptModel,
    audio_dir: Path
) -> Timeline:
    """
    scriptï¼ˆYAML å°æœ¬ï¼‰ã¨ audio_dirï¼ˆéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ï¼‰ã‹ã‚‰
    å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¨ˆç®—ã€‚
    """
```

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼

**1. ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆè¡Œ 45-50ï¼‰**
```python
timelines = []
start_sec = 0.0
for index, section in enumerate(script.sections):
    # å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® duration_sec ã‚’è¨ˆç®—
```

**2. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æ¢ç´¢ï¼ˆè¡Œ 52-65ï¼‰**
```python
audio_file = audio_dir / f"{section.id}.wav"
if audio_file.exists():
    # ffprobe ã§ç§’æ•°å–å¾—
    duration_sec = _get_audio_duration(audio_file)
    has_audio = True
else:
    # ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ¨å®š
    duration_sec = _estimate_duration_from_text(
        section.narration,
        section.on_screen_text
    )
    has_audio = False
```

**3. duration_hint_sec ãƒã‚§ãƒƒã‚¯ï¼ˆè¡Œ 67-70ï¼‰**
```python
if hasattr(section, 'duration_hint_sec') and section.duration_hint_sec:
    # YAML ã§æ˜ç¤ºæŒ‡å®šãŒã‚ã‚Œã°å„ªå…ˆ
    duration_sec = section.duration_hint_sec
```

**4. SectionTimeline ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆï¼ˆè¡Œ 72-85ï¼‰**
```python
timeline = SectionTimeline(
    id=section.id,
    index=index,
    start_sec=start_sec,
    duration_sec=duration_sec,
    on_screen_text=section.on_screen_text,
    narration=section.narration,
    audio_path=audio_file if has_audio else None,
    has_audio=has_audio
)
timelines.append(timeline)
start_sec += duration_sec  # æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚åˆ»æ›´æ–°
```

### ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°

#### _get_audio_duration()ï¼ˆè¡Œ 105-125ï¼‰
```python
def _get_audio_duration(audio_file: Path) -> float:
    """ffprobe ã§ WAV ãƒ•ã‚¡ã‚¤ãƒ«ã®ç§’æ•°ã‚’å–å¾—ã€‚"""
    try:
        result = subprocess.run(
            [
                'ffprobe',
                '-v', 'error',
                '-show_entries', 'format=duration',
                '-of', 'default=noprint_wrappers=1:nokey=1:noprint_wrappers=1',
                str(audio_file)
            ],
            capture_output=True,
            text=True,
            timeout=10
        )
        return float(result.stdout.strip())
    except Exception as e:
        logger.warning(f"ffprobe failed: {e}. Fallback to estimate.")
        return _estimate_duration_from_text("", "")  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 3 ç§’
```

#### _estimate_duration_from_text()ï¼ˆè¡Œ 130-145ï¼‰
```python
def _estimate_duration_from_text(narration: str, on_screen_text: str) -> float:
    """ãƒ†ã‚­ã‚¹ãƒˆé•·ã‹ã‚‰ç¶™ç¶šæ™‚é–“ã‚’æ¨å®šã€‚"""
    total_chars = len(narration) + len(on_screen_text)
    # ç›®å®‰ï¼šæ—¥æœ¬èª 10æ–‡å­— â‰ˆ 3ç§’
    # è‹±èª 5å˜èª â‰ˆ 3ç§’
    if total_chars == 0:
        return 3.0  # æœ€å° 3 ç§’
    estimated_sec = (total_chars / 10.0) * 3.0
    return max(3.0, min(estimated_sec, 60.0))  # 3ï½60 ç§’ã®ç¯„å›²
```

### æˆ»ã‚Šå€¤ï¼šTimeline ã‚¯ãƒ©ã‚¹ï¼ˆè¡Œ 150-160ï¼‰
```python
@dataclass
class Timeline:
    total_duration: float
    sections: List[SectionTimeline]
```

## ğŸ”§ é‹ç”¨ãƒ»ãƒ‡ãƒãƒƒã‚°

### CLI ã§ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç¢ºèª
```bash
python scripts/describe_timeline.py \
  --config configs/config.yaml \
  --script inputs/scripts_yaml/test.yaml | jq .
```
å‡ºåŠ›ä¾‹ï¼š
```json
{
  "total_duration": 145.5,
  "sections": [
    {
      "id": "point1",
      "index": 0,
      "start_sec": 0.0,
      "duration_sec": 28.5,
      "on_screen_text": "ç¬¬1ä½",
      "has_audio": true
    },
    {
      "id": "point2",
      "index": 1,
      "start_sec": 28.5,
      "duration_sec": 32.2,
      ...
    }
  ]
}
```

### ãƒ†ã‚¹ãƒˆï¼ˆè¡Œ 165-180ï¼‰
```python
def test_timeline_calculation():
    script = load_script("tests/fixtures/sample.yaml")
    timeline = build_timeline(script, Path("tests/fixtures/audio"))
    
    # åˆè¨ˆæ™‚é–“ã‚’ãƒã‚§ãƒƒã‚¯
    assert timeline.total_duration > 0
    
    # ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ•°
    assert len(timeline.sections) == len(script.sections)
    
    # é–‹å§‹æ™‚åˆ»ã¯å˜èª¿å¢—åŠ 
    for i in range(len(timeline.sections) - 1):
        assert timeline.sections[i].start_sec < timeline.sections[i+1].start_sec
```

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | å¯¾ç­– |
|------|------|------|
| ffprobe not found | FFmpeg æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | `brew install ffmpeg` |
| audio_path ãŒå­˜åœ¨ã—ãªã„ | éŸ³å£°ç”Ÿæˆã‚¹ã‚­ãƒƒãƒ— | `generate_audio.py` ã§å…ˆã«éŸ³å£°ç”Ÿæˆ |
| duration_sec = 0 | ãƒ†ã‚­ã‚¹ãƒˆé•·æ¨å®šå¤±æ•— | `duration_hint_sec` ã‚’ YAML ã§æ˜ç¤º |

## ğŸ”— å‚è€ƒ
- **å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: [src/timeline.py](../../../src/timeline.py)
- **ãƒ¢ãƒ‡ãƒ«å®šç¾©**: [src/models.py](../../../src/models.py)ï¼ˆScriptModel, Sectionï¼‰
- **ä½¿ç”¨ç®‡æ‰€**: [scripts/describe_timeline.py](../../../scripts/describe_timeline.py), [scripts/generate_video.py](../../../scripts/generate_video.py)
- **ãƒ†ã‚¹ãƒˆ**: [tests/test_timeline.py](../../../tests/test_timeline.py)

## âœ… ã¾ã¨ã‚
- `build_timeline()` ã§å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚åˆ»ãƒ»ç¶™ç¶šæ™‚é–“ã‚’è¨ˆç®—ã€‚
- ffprobe ã§å®ŸéŸ³å£°ã®ç§’æ•°å–å¾—ã€‚ãªã‘ã‚Œã°ãƒ†ã‚­ã‚¹ãƒˆæ¨å®šã€‚
- duration_hint_sec ã§æ‰‹å‹•æŒ‡å®šå¯èƒ½ã€‚
- Timeline ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ FFmpeg filter chain ã«ç§’æ•°ã‚’æ¸¡ã™ã€‚
- ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ•°ãƒ»ãƒ†ã‚­ã‚¹ãƒˆé‡ãŒå¤§ãã„ã¨è¨ˆç®—æ™‚é–“å¢—åŠ ã€‚æœ€é©åŒ–æ¤œè¨è¦ã€‚

## ğŸš€ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- å¤§è¦æ¨¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ50+ï¼‰ã§ã®è¨ˆç®—æœ€é©åŒ–ã€‚
- éŸ³å£°ç”Ÿæˆã¨ä¸¦åˆ—å‡¦ç†ã§å…¨ä½“æ™‚é–“çŸ­ç¸®ã€‚
- ãƒ†ã‚­ã‚¹ãƒˆæ¨å®šç²¾åº¦ã®å¤šè¨€èªå¯¾å¿œã€‚

## ğŸ—“ï¸ è¿½è¨˜/æ›´æ–°ãƒ­ã‚°
- 2025-12-23: åˆç‰ˆã€‚Lv3 è©³ç´°ä»•æ§˜ã¨ã—ã¦ä½œæˆã€‚
