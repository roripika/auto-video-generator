# ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å®Ÿè£… (Lv3 è©³ç´°ä»•æ§˜)

## âœ¨ TL;DR
- Desktop Appï¼ˆElectronï¼‰ã®ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã§ Vue.js + Canvas ã‚’ç”¨ã„ãŸç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€‚
- ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ IPC ã§ YAMLãƒ»ç”»åƒãƒ»ãƒ†ãƒ­ãƒƒãƒ—æƒ…å ±ã‚’å—ä¿¡ã€‚
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æç”»ï¼šèƒŒæ™¯ â†’ ãƒ†ãƒ­ãƒƒãƒ— â†’ ãƒ†ãƒ­ãƒƒãƒ—ãƒœãƒƒã‚¯ã‚¹ â†’ æ ç·šã€‚
- `desktop-app/src/renderer/preview.js` (Vue ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ) + `desktop-app/src/main/ipc-handlers.js` (IPC é€šä¿¡)ã€‚
- å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ï¼š[desktop-app/src/renderer/preview.js](../../../desktop-app/src/renderer/preview.js) å…¨ä½“ã€‚

## ğŸ“š ç”¨èªãƒ»å‰æ
- **IPCï¼ˆInter-Process Communicationï¼‰**: Electron ã§ Main â†” Renderer é–“ãƒ‡ãƒ¼ã‚¿é€šä¿¡ã€‚
- **Canvas**: HTML5 Canvas API ã§ 2D ç”»åƒæç”»ã€‚
- **Vue.js**: UI ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚reactive data ã§ UI æ›´æ–°è‡ªå‹•ã€‚
- **onPreviewUpdate**: IPC ã‚¤ãƒ™ãƒ³ãƒˆåã€‚Main ã‹ã‚‰ Renderer ã« YAMLãƒ»ç´ ææ›´æ–°ã‚’é€šçŸ¥ã€‚

## ğŸ§­ èƒŒæ™¯
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ YAMLãƒ»ãƒ†ãƒ­ãƒƒãƒ—ãƒ»èƒŒæ™¯ã‚’ç·¨é›†ä¸­ã«ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºèªã—ãŸã„ã€‚
- FFmpeg å®Ÿè¡Œå‰ã«è¦–è¦šçš„ã«æ¤œè¨¼ã™ã‚‹ã“ã¨ã§ã€å¤±æ•—ã®ãƒ«ãƒ¼ãƒ—ã‚’å‰Šæ¸›ã€‚
- è¤‡æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºæ™‚ã«ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³é¸æŠãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚·ãƒ¼ã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆã€‚

## ğŸ—ï¸ å®Ÿè£…è©³ç´°

### IPC ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆMain ãƒ—ãƒ­ã‚»ã‚¹ï¼‰ï¼ˆ[src/main/ipc-handlers.js](../../../desktop-app/src/main/ipc-handlers.js) è¡Œ 200-250ï¼‰

#### onPreviewUpdate ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
```javascript
ipcMain.on('onPreviewUpdate', (event, data) => {
  /*
  data: {
    yaml_script: { sections: [...], bgm_file: "...", ... },
    timeline: { total_duration: 145.5, sections: [...] },
    selected_section_idx: 0,
    dry_run: false
  }
  */
  
  // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã«è»¢é€
  mainWindow.webContents.send('onPreviewUpdate', data);
});
```

### Vue ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆRenderer ãƒ—ãƒ­ã‚»ã‚¹ï¼‰ï¼ˆ[desktop-app/src/renderer/preview.js](../../../desktop-app/src/renderer/preview.js) è¡Œ 1-100ï¼‰

#### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```vue
<template>
  <div class="preview-container">
    <canvas 
      ref="previewCanvas" 
      width="1920" 
      height="1080"
      @click="on_canvas_click"
    />
    <div class="section-navigator">
      <button 
        v-for="(section, idx) in timeline.sections"
        :key="idx"
        :class="{ active: selected_section_idx === idx }"
        @click="select_section(idx)"
      >
        {{ section.id }}
      </button>
    </div>
  </div>
</template>
```

#### data()
```javascript
export default {
  name: 'Preview',
  data() {
    return {
      canvas: null,
      ctx: null,
      yaml_script: null,
      timeline: null,
      selected_section_idx: 0,
      background_image: null,
      is_loading: false
    };
  },

  mounted() {
    this.canvas = this.$refs.previewCanvas;
    this.ctx = this.canvas.getContext('2d');

    // IPC ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
    window.ipcRenderer.on('onPreviewUpdate', (event, data) => {
      this.handle_preview_update(data);
    });
  }
};
```

### Core Drawing ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè¡Œ 105-200ï¼‰

#### handle_preview_update()ï¼ˆãƒ‡ãƒ¼ã‚¿å—ä¿¡æ™‚ï¼‰
```javascript
async handle_preview_update(data) {
  this.is_loading = true;
  
  this.yaml_script = data.yaml_script;
  this.timeline = data.timeline;
  this.selected_section_idx = data.selected_section_idx || 0;

  // èƒŒæ™¯ç”»åƒã‚’å…ˆèª­ã¿
  const section = this.yaml_script.sections[this.selected_section_idx];
  const bg_path = section.background_image_path;
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ file:// URL ã«å¤‰æ›
  const file_url = `file://${bg_path}`;
  
  try {
    this.background_image = await this.load_image(file_url);
    this.redraw();
  } catch (error) {
    console.error('èƒŒæ™¯ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—:', error);
    this.draw_error_message(`èƒŒæ™¯ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${bg_path}`);
  }
  
  this.is_loading = false;
}
```

#### load_image()ï¼ˆç”»åƒå…ˆèª­ã¿ï¼‰
```javascript
load_image(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = (err) => reject(err);
    img.src = url;
  });
}
```

#### redraw()ï¼ˆæç”»å®Ÿè¡Œï¼‰
```javascript
redraw() {
  if (!this.canvas || !this.ctx) return;

  const ctx = this.ctx;
  const section = this.yaml_script.sections[this.selected_section_idx];
  const section_timeline = this.timeline.sections[this.selected_section_idx];

  // Step 1: èƒŒæ™¯ã‚’æç”»
  if (this.background_image) {
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èƒŒæ™¯ã‚’ scale
    ctx.drawImage(
      this.background_image,
      0, 0,
      this.canvas.width, this.canvas.height
    );
  } else {
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯ï¼ˆé»’ï¼‰
    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
  }

  // Step 2: ãƒ†ãƒ­ãƒƒãƒ—ãƒœãƒƒã‚¯ã‚¹ã‚’æç”»
  this.draw_ticker_box(ctx, section_timeline);

  // Step 3: ãƒ†ãƒ­ãƒƒãƒ—ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
  this.draw_ticker_text(ctx, section_timeline, section);

  // Step 4: æ ç·šã‚’æç”»
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 2;
  ctx.strokeRect(0, 0, this.canvas.width, this.canvas.height);
}
```

#### draw_ticker_box()ï¼ˆãƒ†ãƒ­ãƒƒãƒ—ãƒœãƒƒã‚¯ã‚¹ï¼‰
```javascript
draw_ticker_box(ctx, section_timeline) {
  // ãƒ†ãƒ­ãƒƒãƒ—ãƒœãƒƒã‚¯ã‚¹ã®ä½ç½®ãƒ»ã‚µã‚¤ã‚º
  const box_height = 120;
  const box_y = this.canvas.height - box_height - 20;
  const box_x = 20;
  const box_width = this.canvas.width - 40;

  // èƒŒæ™¯ï¼šé»’é€é
  ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
  ctx.fillRect(box_x, box_y, box_width, box_height);

  // æ ç·šï¼šç™½
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 2;
  ctx.strokeRect(box_x, box_y, box_width, box_height);
}
```

#### draw_ticker_text()ï¼ˆãƒ†ãƒ­ãƒƒãƒ—ãƒ†ã‚­ã‚¹ãƒˆï¼‰
```javascript
draw_ticker_text(ctx, section_timeline, section) {
  const text = section_timeline.on_screen_text;

  // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
  const font_name = section.font_name || 'Noto Sans JP';
  const font_size = 64;
  ctx.font = `${font_size}px "${font_name}", sans-serif`;
  ctx.fillStyle = '#ffffff';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  // ãƒ†ã‚­ã‚¹ãƒˆä½ç½®
  const x = this.canvas.width / 2;
  const y = this.canvas.height - 80;

  // ãƒ†ã‚­ã‚¹ãƒˆæç”»
  try {
    // é•·ãƒ†ã‚­ã‚¹ãƒˆã¯è‡ªå‹•æŠ˜ã‚Šè¿”ã—
    const wrapped_text = this.wrap_text(text, ctx, this.canvas.width - 100);
    wrapped_text.forEach((line, idx) => {
      ctx.fillText(line, x, y + idx * (font_size + 10));
    });
  } catch (error) {
    console.error('ãƒ†ã‚­ã‚¹ãƒˆæç”»å¤±æ•—:', error);
    ctx.fillText('ãƒ†ã‚­ã‚¹ãƒˆæç”»ã‚¨ãƒ©ãƒ¼', x, y);
  }
}
```

#### wrap_text()ï¼ˆãƒ†ã‚­ã‚¹ãƒˆæŠ˜ã‚Šè¿”ã—ï¼‰
```javascript
wrap_text(text, ctx, max_width) {
  const words = text.split('');  // æ–‡å­—å˜ä½
  const lines = [];
  let current_line = '';

  words.forEach((char) => {
    const test_line = current_line + char;
    const metrics = ctx.measureText(test_line);

    if (metrics.width > max_width && current_line) {
      lines.push(current_line);
      current_line = char;
    } else {
      current_line = test_line;
    }
  });

  if (current_line) lines.push(current_line);
  return lines;
}
```

### ã‚»ã‚¯ã‚·ãƒ§ãƒ³é¸æŠãƒ»ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè¡Œ 205-240ï¼‰

#### select_section()
```javascript
select_section(idx) {
  this.selected_section_idx = idx;
  this.redraw();

  // é¸æŠæƒ…å ±ã‚’ Main ã«è¿”ã™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  window.ipcRenderer.send('onSectionSelected', {
    section_idx: idx,
    section_id: this.yaml_script.sections[idx].id
  });
}
```

#### on_canvas_click()ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç§»å‹•ï¼‰
```javascript
on_canvas_click(event) {
  const rect = this.canvas.getBoundingClientRect();
  const click_x = event.clientX - rect.left;

  // å·¦åŠåˆ† â†’ å‰ã¸
  if (click_x < this.canvas.width / 2 && this.selected_section_idx > 0) {
    this.select_section(this.selected_section_idx - 1);
  }
  // å³åŠåˆ† â†’ æ¬¡ã¸
  else if (click_x >= this.canvas.width / 2 && 
           this.selected_section_idx < this.timeline.sections.length - 1) {
    this.select_section(this.selected_section_idx + 1);
  }
}
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆè¡Œ 245-260ï¼‰

#### draw_error_message()
```javascript
draw_error_message(message) {
  const ctx = this.ctx;

  // èƒŒæ™¯ï¼šèµ¤é€é
  ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
  ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  ctx.fillStyle = '#ffffff';
  ctx.font = '48px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(message, this.canvas.width / 2, this.canvas.height / 2);
}
```

## ğŸ”§ é‹ç”¨ãƒ»ãƒ‡ãƒãƒƒã‚°

### Desktop App ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
1. YAML ã‚’ç·¨é›†ï¼ˆãƒ†ãƒ­ãƒƒãƒ—ãƒ»èƒŒæ™¯å¤‰æ›´ï¼‰
2. "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
3. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒ IPC ã§ Main â†â†’ Renderer é€šä¿¡
4. Canvas ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æç”»
5. å·¦å³ã‚¯ãƒªãƒƒã‚¯ã§ã‚»ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ

### IPC ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»•æ§˜

| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | æ–¹å‘ | ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ |
|-----------|------|-----------|
| onPreviewUpdate | Main â†’ Renderer | { yaml_script, timeline, selected_section_idx } |
| onSectionSelected | Renderer â†’ Main | { section_idx, section_id } |

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | å¯¾ç­– |
|------|------|------|
| èƒŒæ™¯ç”»åƒãŒé»’ã„ | èƒŒæ™¯ãƒ‘ã‚¹é–“é•ã„ ã¾ãŸã¯ ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ã—ãªã„ | YAML ã§èƒŒæ™¯ãƒ‘ã‚¹ã‚’ç¢ºèª |
| ãƒ†ãƒ­ãƒƒãƒ—ãŒæ–‡å­—åŒ–ã‘ | ãƒ•ã‚©ãƒ³ãƒˆæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | _resolve_font_path() ã§è£œå®Œ (Lv3-01) |
| Canvas æç”»é…ã„ | å¤§ããªèƒŒæ™¯ç”»åƒï¼ˆ>4Kï¼‰ | èƒŒæ™¯ã‚’ 1920x1080 ã« ãƒªã‚µã‚¤ã‚º |
| IPC é€šä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | Main â†” Renderer å¿œç­”é…å»¶ | timeout è¨­å®šã‚’å¢—ã‚„ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 5ç§’ï¼‰ |

## ğŸ”— å‚è€ƒ
- **å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: [desktop-app/src/renderer/preview.js](../../../desktop-app/src/renderer/preview.js)
- **IPC ãƒãƒ³ãƒ‰ãƒ©ãƒ¼**: [desktop-app/src/main/ipc-handlers.js](../../../desktop-app/src/main/ipc-handlers.js)
- **ãƒ•ã‚©ãƒ³ãƒˆè§£æ±º**: [src/render/ffmpeg_runner.py#L43](../../../src/render/ffmpeg_runner.py#L43)ï¼ˆLv3-01ï¼‰
- **ãƒ†ã‚¹ãƒˆ**: [tests/test_ui_ipc_handlers.md](../../../tests/TEST_UI_IPC_README.md)
- **Electron IPC**: https://www.electronjs.org/docs/tutorial/ipc
- **HTML5 Canvas**: https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API

## âœ… ã¾ã¨ã‚
- Vue.js + Canvas ã§ YAMLãƒ»èƒŒæ™¯ãƒ»ãƒ†ãƒ­ãƒƒãƒ—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æç”»ã€‚
- IPC ã§ Main â†â†’ Renderer ãƒ‡ãƒ¼ã‚¿é€£æºã€‚
- ã‚»ã‚¯ã‚·ãƒ§ãƒ³é¸æŠãƒ»ãƒ†ã‚­ã‚¹ãƒˆæŠ˜ã‚Šè¿”ã—ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¯¾å¿œã€‚
- FFmpeg å®Ÿè¡Œå‰ã«è¦–è¦šçš„æ¤œè¨¼ã€‚
- _resolve_font_path() ã§æ–‡å­—åŒ–ã‘å¯¾ç­–ã€‚

## ğŸš€ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- Zoom/Pan ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œã€‚
- ã‚¿ã‚¤ãƒ ã‚·ãƒ¼ã‚¯ï¼ˆæ™‚é–“è»¸ã§ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºï¼‰æ©Ÿèƒ½ã€‚
- è¤‡æ•°ãƒ•ã‚©ãƒ³ãƒˆãƒ»è‰²ãƒ»é…ç½®ã®çµ„åˆã›ãƒ—ãƒªã‚»ãƒƒãƒˆã€‚
- é«˜DPI ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œï¼ˆRetina ç­‰ï¼‰ã€‚

## ğŸ—“ï¸ è¿½è¨˜/æ›´æ–°ãƒ­ã‚°
- 2025-12-23: åˆç‰ˆã€‚Lv3 è©³ç´°ä»•æ§˜ã¨ã—ã¦ä½œæˆã€‚
