# ğŸ”¤ ãƒ•ã‚©ãƒ³ãƒˆè§£æ±ºã‚·ã‚¹ãƒ†ãƒ  (Lv3 è©³ç´°ä»•æ§˜)

## âœ¨ TL;DR
- FFmpeg ã® drawtext ãƒ•ã‚£ãƒ«ã‚¿ã«ç›´æ¥ãƒ•ã‚©ãƒ³ãƒˆåï¼ˆ"Noto Sans JP"ç­‰ï¼‰ã‚’æ¸¡ã™ã¨æ–‡å­—åŒ–ã‘ã€‚
- `_resolve_font_path()` é–¢æ•°ãŒ fontname â†’ ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆçµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›ã€‚
- Linux/macOS ã§ `fc-match -f "%{file}" font_name` ã‚’å®Ÿè¡Œã€macOS ã¯æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
- LRU ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ`_FONT_CACHE`ï¼‰ã§ç¹°ã‚Šè¿”ã—å‘¼ã³å‡ºã—ã®æ€§èƒ½æ”¹å–„ã€‚
- å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ï¼š[src/render/ffmpeg_runner.py](../../../src/render/ffmpeg_runner.py) è¡Œ 43-89ã€‚

## ğŸ“š ç”¨èªãƒ»å‰æ
- **fontfile**: FFmpeg drawtext ã® fontfile ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚çµ¶å¯¾ãƒ‘ã‚¹å¿…é ˆã€‚
- **fc-match**: fontconfig ã® CLI ãƒ„ãƒ¼ãƒ«ã€‚ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ•ã‚©ãƒ³ãƒˆã‹ã‚‰æœ€é©ãªã‚‚ã®ã‚’æ¢ç´¢ã€‚
- **macOS fallback**: macOS ã¯ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯ï¼ˆ`/System/Library/Fonts/ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯ W4.ttc` ç­‰ï¼‰ã‚’å„ªå…ˆã€‚
- **Verdana/Arial detection**: fc-match ãŒ Verdana/Arial ã‚’è¿”ã—ãŸå ´åˆã¯ã€LLM "Noto Sans JP" æŒ‡å®šã§ã‚‚æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã«å¼·åˆ¶å¤‰æ›´ã€‚
- **_FONT_CACHE**: dict å½¢å¼ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€‚`{font_name: resolved_path}`ã€‚

## ğŸ§­ èƒŒæ™¯ï¼ˆå®Ÿè£…æ–¹é‡ï¼‰
- FFmpeg drawtext ã« `fontfile='Noto Sans JP'` ã§æ¸¡ã™ã¨ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãš drawtext ã‚¨ãƒ©ãƒ¼ã€‚
- ã•ã‚‰ã«ã€ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã™ã‚‹ã¨ã€Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆã€ã§æç”»ã•ã‚Œã€æ–‡å­—åŒ–ã‘ï¼ˆç‰¹ã«CJKï¼‰ã€‚
- æ ¹æœ¬è§£æ±ºï¼šfontname ã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ ä¸Šã®å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—ã—ã€drawtext ã«çµ¶å¯¾ãƒ‘ã‚¹ã§æ¸¡ã™ã€‚
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼šæ¯ãƒ•ãƒ¬ãƒ¼ãƒ åŒã˜ãƒ•ã‚©ãƒ³ãƒˆè§£æ±ºã‚’è¡Œã‚ãªã„ã‚ˆã† LRU ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€‚

## ğŸ—ï¸ å®Ÿè£…è©³ç´°

### é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£
```python
def _resolve_font_path(font_name: str) -> str:
    """
    ãƒ•ã‚©ãƒ³ãƒˆåã‚’ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆçµ¶å¯¾ãƒ‘ã‚¹ã«è§£æ±ºã€‚
    - Linux/macOS: fc-match ã§æ¤œç´¢ã€‚
    - macOS: æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
    - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§æ€§èƒ½æ”¹å–„ã€‚
    """
```

### å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ

#### 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªï¼ˆè¡Œ 51-52ï¼‰
```python
if font_name in _FONT_CACHE:
    return _FONT_CACHE[font_name]
```

#### 2. fc-match ã«ã‚ˆã‚‹è§£æ±ºï¼ˆè¡Œ 55-63ï¼‰
```python
try:
    result = subprocess.run(
        ['fc-match', '-f', '%{file}', font_name],
        capture_output=True,
        text=True,
        timeout=5
    )
    if result.returncode == 0:
        path = result.stdout.strip()
```
- `fc-match -f "%{file}"` ã§æœ€é©ãƒ•ã‚©ãƒ³ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—ã€‚
- stdout ãŒè¿”ã•ã‚Œã‚Œã°ã€ãã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã€‚

#### 3. Verdana/Arial æ¤œå‡ºã¨å¼·åˆ¶å¤‰æ›´ï¼ˆè¡Œ 64-73ï¼‰
```python
if any(x in path for x in ['Verdana', 'Arial']):
    # "Noto Sans JP" æŒ‡å®šãªã®ã« Verdana ãŒè¿”ã•ã‚ŒãŸå ´åˆ
    if 'JP' in font_name or 'æ—¥æœ¬' in font_name:
        # macOS æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        path = _RESOLVE_MACOS_FALLBACK(font_name)
```
- "Noto Sans JP" æŒ‡å®šã§ã‚‚ fc-match ãŒè‹±æ–‡ãƒ•ã‚©ãƒ³ãƒˆï¼ˆVerdana/Arialï¼‰ã‚’è¿”ã™å ´åˆã€æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã«å¼·åˆ¶å¤‰æ›´ã€‚

#### 4. macOS ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆè¡Œ 75-89ï¼‰
```python
_MACOS_JP_FONTS = [
    '/System/Library/Fonts/ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯ W4.ttc',
    '/System/Library/Fonts/ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯ W3.ttc',
    '/System/Library/Fonts/Hiragino Sans GB.ttc',
    '/Library/Fonts/Arial Unicode.ttf',
]
for font_path in _MACOS_JP_FONTS:
    if Path(font_path).exists():
        return font_path
```
- å„ªå…ˆåº¦é †ã« macOS ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆã‚’ç¢ºèªã€‚
- æœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‚ã®ã‚’è¿”ã™ã€‚

#### 5. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆè¡Œ 85ï¼‰
```python
_FONT_CACHE[font_name] = path
return path
```
- è§£æ±ºçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã—ã€æ¬¡å›å‘¼ã³å‡ºã—ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã€‚

### ä½¿ç”¨å ´æ‰€ï¼ˆ6ç®‡æ‰€ã§åˆ©ç”¨ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œç•ªå· | ãƒ•ã‚£ãƒ«ã‚¿ | ç”¨é€” |
|---------|-------|---------|------|
| ffmpeg_runner.py | 199 | drawtext | ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ­ãƒƒãƒ—æç”» |
| ffmpeg_runner.py | 220 | drawtext | å‰¯ãƒ†ãƒ­ãƒƒãƒ—ï¼ˆbridgeç­‰ï¼‰ |
| ffmpeg_runner.py | 337 | drawtext | ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ†ã‚­ã‚¹ãƒˆ |
| ffmpeg_runner.py | 360 | drawtext | ã‚¿ã‚¤ãƒˆãƒ«ãƒ†ãƒ­ãƒƒãƒ— |
| ffmpeg_runner.py | 429 | drawtext | ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ†ãƒ­ãƒƒãƒ— |
| ffmpeg_runner.py | 542 | drawtext | å­—å¹•ï¼ˆSRTçµ±åˆæ™‚ï¼‰ |

### å‘¼ã³å‡ºã—ä¾‹
```python
# Before (æ–‡å­—åŒ–ã‘ã®åŸå› )
fontfile = 'Noto Sans JP'
drawtext_filter = f"drawtext=fontfile='{fontfile}':..."

# After (ãƒ•ã‚©ãƒ³ãƒˆè§£æ±º)
fontfile = _resolve_font_path('Noto Sans JP')
# â†’ '/System/Library/Fonts/ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯ W4.ttc'
drawtext_filter = f"drawtext=fontfile='{fontfile}':..."
```

## ğŸ”§ é‹ç”¨ãƒ»ãƒ‡ãƒãƒƒã‚°

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆå†åˆæœŸåŒ–ï¼‰
```python
# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒªã‚»ãƒƒãƒˆ
_FONT_CACHE.clear()
```
- æ–°ã—ã„ãƒ•ã‚©ãƒ³ãƒˆè¿½åŠ å¾Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†è§£æ±ºã€‚

### ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰
```python
import logging
logger = logging.getLogger(__name__)
logger.debug(f"Font resolved: {font_name} â†’ {path}")
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
# dry-run ã§ FFmpeg ã‚³ãƒãƒ³ãƒ‰å‡ºåŠ›ã€fontfile ãƒ‘ã‚¹ã‚’ç¢ºèª
python scripts/generate_video.py \
  --script inputs/scripts_yaml/test.yaml \
  --dry-run | grep fontfile
```

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | å¯¾ç­– |
|------|------|------|
| `fc-match: command not found` | fontconfig æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | `brew install fontconfig` or `apt install fontconfig` |
| drawtext ãŒæ²ˆé»™ | fc-match ãŒãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’è¿”ã•ãªã„ | macOS fallback ã§å¯¾å¿œã€‚ãƒ­ã‚°ã§ç¢ºèªã€‚ |
| ãƒ’ãƒ©ã‚®ãƒãŒè¦‹ã¤ã‹ã‚‰ãªã„ | macOS ã§ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆå‰Šé™¤ | `/System/Library/Fonts/` ã‚’ç¢ºèªã€‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã° `/Library/Fonts/` ã‚’æ¤œç´¢ã€‚ |

## ğŸ”— å‚è€ƒ
- **å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: [src/render/ffmpeg_runner.py](../../../src/render/ffmpeg_runner.py#L43-L89)
- **ãƒ†ã‚¹ãƒˆ**: [tests/test_drawtext_escaping.py](../../../tests/test_drawtext_escaping.py)
- **FFmpeg drawtext ä»•æ§˜**: https://ffmpeg.org/ffmpeg-filters.html#drawtext-1
- **fontconfig**: https://www.freedesktop.org/software/fontconfig/

## âœ… ã¾ã¨ã‚
- `_resolve_font_path()` ãŒ fontname â†’ çµ¶å¯¾ãƒ‘ã‚¹ã«è‡ªå‹•å¤‰æ›ã€‚
- fc-match ã§æ¤œç´¢ã€macOS ã¯æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
- LRU ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§æ€§èƒ½æœ€é©åŒ–ã€‚
- Verdana/Arial æ¤œå‡ºã§ã€ä¸é©åˆ‡ãªãƒ•ã‚©ãƒ³ãƒˆè¿”å´ã‚’é˜²æ­¢ã€‚
- FFmpeg drawtext ã§æ–‡å­—åŒ–ã‘ã‚’å®Œå…¨è§£æ±ºã€‚

## ğŸš€ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- å¤šè¨€èªãƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œï¼ˆä¸­æ–‡ã€éŸ“æ–‡ã€ã‚¢ãƒ©ãƒ“ã‚¢èªç­‰ï¼‰ã® ãƒ†ã‚¹ãƒˆè¿½åŠ ã€‚
- ãƒ•ã‚©ãƒ³ãƒˆæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã® fallback UI ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã€‚
- GPU ãƒ•ã‚©ãƒ³ãƒˆ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¯¾å¿œï¼ˆNVIDIA/Apple Metalï¼‰ã€‚

## ğŸ—“ï¸ è¿½è¨˜/æ›´æ–°ãƒ­ã‚°
- 2025-12-23: åˆç‰ˆã€‚Lv3 è©³ç´°ä»•æ§˜ã¨ã—ã¦ä½œæˆï¼ˆæ–‡å­—åŒ–ã‘å¯¾ç­–ã®å®Ÿè£…è©³ç´°ï¼‰ã€‚
